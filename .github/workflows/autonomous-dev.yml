name: ðŸ¤– Autonomous Development

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:
    inputs:
      idea_id:
        description: 'Specific idea ID to work on'
        required: false
      vibe:
        description: 'Quick idea description (creates new idea automatically)'
        required: false
      force_new:
        description: 'Start fresh (ignore resume state)'
        type: boolean
        default: false

jobs:
  autonomous_work:
    name: ðŸš€ Autonomous Dev Session
    runs-on: ubuntu-latest
    timeout-minutes: 25  # 25-minute timeout
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev  # Always work on dev branch

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ¤– Install OpenClaw CLI
        run: |
          # Install openclaw CLI
          npm install -g openclaw
          # Or: curl -sSL https://openclaw.dev/install.sh | bash
          openclaw --version

      - name: ðŸ’¡ Create Idea from Vibe
        id: create_idea
        if: ${{ inputs.vibe != '' }}
        run: |
          echo "ðŸŽ¨ Creating idea from vibe: ${{ inputs.vibe }}"
          OUTPUT_JSON=true node scripts/create-idea.js "${{ inputs.vibe }}" > /tmp/idea-output.txt

          # Extract JSON output
          IDEA_JSON=$(tail -n 1 /tmp/idea-output.txt)
          IDEA_ID=$(echo $IDEA_JSON | jq -r '.ideaId')

          echo "idea_id=$IDEA_ID" >> $GITHUB_OUTPUT
          echo "âœ… Created idea with ID: $IDEA_ID"

      - name: ðŸ” Resume from Last State
        id: resume
        run: |
          if [ "${{ inputs.force_new }}" == "true" ]; then
            echo "ðŸ†• Starting fresh session"
            echo "resume=false" >> $GITHUB_OUTPUT
          elif [ -f "state/current-session.json" ]; then
            echo "ðŸ“‚ Resuming from previous session"
            echo "resume=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ†• No previous state found"
            echo "resume=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŽ¯ Run Autonomous Orchestrator (LangGraph + Failover)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL: ${{ vars.MODEL || 'opencode/gpt-5-nano' }}  # OpenCode models via OpenClaw
          OPENCODE_MODEL: ${{ vars.OPENCODE_MODEL || 'opencode/gpt-5-nano' }}  # Fallback
          IDEA_ID: ${{ steps.create_idea.outputs.idea_id || inputs.idea_id }}
          RESUME: ${{ steps.resume.outputs.resume }}
          TIMEOUT_MINUTES: 23  # Leave 2min buffer for cleanup
        run: node scripts/orchestrator-with-failover.js

      - name: ðŸ’¾ Commit Progress
        if: always()
        run: |
          git config --local user.email "bot@autonomous-dev.local"
          git config --local user.name "Autonomous Dev Bot"

          # Stage all changes
          git add -A

          # Check if there are changes
          if ! git diff --staged --quiet; then
            # Get milestone from state
            MILESTONE=$(node -e "const s=require('./state/current-session.json');console.log(s.milestone||'Progress update')")

            git commit -m "ðŸ¤– Auto: $MILESTONE [skip ci]"
            git push origin dev
            echo "âœ… Committed and pushed to dev"
          else
            echo "â­ï¸ No changes to commit"
          fi

      - name: ðŸ“Š Update GitHub Issues
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/utils/issue-tracker.js sync

      - name: ðŸ“ˆ Generate Summary
        if: always()
        run: |
          echo "## ðŸ¤– Autonomous Dev Session Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "state/current-session.json" ]; then
            node -e "
              const s = require('./state/current-session.json');
              console.log(\`**Idea:** \${s.idea_id || 'N/A'}\`);
              console.log(\`**Status:** \${s.status || 'unknown'}\`);
              console.log(\`**Progress:** \${s.progress || 0}%\`);
              console.log(\`**Milestone:** \${s.milestone || 'N/A'}\`);
              console.log(\`**Next Step:** \${s.next_step || 'TBD'}\`);
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "No session state found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: ðŸ§¹ Cleanup
    needs: [autonomous_work]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Runner Status
        run: echo "Session completed with status: ${{ needs.autonomous_work.result }}"
