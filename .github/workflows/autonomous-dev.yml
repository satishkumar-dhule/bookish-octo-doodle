name: ðŸ¤– Autonomous Development

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:
    inputs:
      idea_id:
        description: 'Specific idea ID to work on'
        required: false
      vibe:
        description: 'Quick idea description (creates new idea automatically)'
        required: false
      force_new:
        description: 'Start fresh (ignore resume state)'
        type: boolean
        default: false

jobs:
  autonomous_work:
    name: ðŸš€ Autonomous Dev Session
    runs-on: ubuntu-latest
    timeout-minutes: 25  # 25-minute timeout
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev  # Always work on dev branch

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ¤– Install OpenCode AI CLI
        run: |
          # Install the real opencode-ai package
          npm install -g opencode-ai

          # Verify installation
          opencode --version

          # Create openclaw alias pointing to opencode for backward compatibility
          echo '#!/bin/bash' | sudo tee /usr/local/bin/openclaw > /dev/null
          echo 'exec opencode "$@"' | sudo tee -a /usr/local/bin/openclaw > /dev/null
          sudo chmod +x /usr/local/bin/openclaw

          echo "âœ… OpenCode AI installed successfully"

      - name: ðŸŒ Install Cloudflared
        run: |
          # Download and install cloudflared
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared --version
          echo "âœ… Cloudflared installed"

      - name: ðŸš€ Start OpenCode Web Server
        run: |
          # Start opencode web in background
          nohup opencode web --port 3000 > /tmp/opencode-web.log 2>&1 &
          WEB_PID=$!
          echo $WEB_PID > /tmp/opencode-web.pid
          echo "ðŸš€ OpenCode web server started (PID: $WEB_PID)"

          # Wait and verify server is running
          echo "â³ Waiting for web server to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Web server is responding on port 3000"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Web server failed to start"
              cat /tmp/opencode-web.log
              exit 1
            fi
            sleep 1
          done

          # Start cloudflared tunnel in background
          nohup cloudflared tunnel --url http://localhost:3000 > /tmp/cloudflared.log 2>&1 &
          TUNNEL_PID=$!
          echo $TUNNEL_PID > /tmp/cloudflared.pid
          echo "ðŸŒ Cloudflared tunnel started (PID: $TUNNEL_PID)"

          # Wait for tunnel to establish and extract URL
          echo "â³ Waiting for tunnel to establish..."
          for i in {1..30}; do
            TUNNEL_URL=$(grep -o 'https://[^[:space:]]*\.trycloudflare\.com' /tmp/cloudflared.log 2>/dev/null | head -1)
            if [ -n "$TUNNEL_URL" ]; then
              echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT
              echo "ðŸŒ OpenCode Web accessible at: $TUNNEL_URL"
              echo "OPENCODE_WEB_URL=$TUNNEL_URL" >> $GITHUB_ENV

              # Verify tunnel is working
              sleep 2
              if curl -s "$TUNNEL_URL" > /dev/null 2>&1; then
                echo "âœ… Tunnel is accessible and working"
              else
                echo "âš ï¸ Tunnel URL generated but not yet accessible (may need more time)"
              fi
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Tunnel URL not found in logs"
              cat /tmp/cloudflared.log
              exit 1
            fi
            sleep 1
          done
        id: opencode_web

      - name: ðŸ’¡ Create Idea from Vibe
        id: create_idea
        if: ${{ inputs.vibe != '' }}
        run: |
          echo "ðŸŽ¨ Creating idea from vibe: ${{ inputs.vibe }}"
          OUTPUT_JSON=true node scripts/create-idea.js "${{ inputs.vibe }}" > /tmp/idea-output.txt

          # Extract JSON output
          IDEA_JSON=$(tail -n 1 /tmp/idea-output.txt)
          IDEA_ID=$(echo $IDEA_JSON | jq -r '.ideaId')

          echo "idea_id=$IDEA_ID" >> $GITHUB_OUTPUT
          echo "âœ… Created idea with ID: $IDEA_ID"

      - name: ðŸ’¾ Commit New Idea
        if: ${{ inputs.vibe != '' }}
        run: |
          git config --local user.email "satishkumar.dhule@gmail.com"
          git config --local user.name "satishkumar-dhule"
          git add ideas/backlog/
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– Auto: Add idea from vibe [skip ci]"
            git push origin dev
            echo "âœ… Idea committed and pushed"
          fi

      - name: ðŸ”„ Pull Latest Changes
        run: |
          git pull origin dev --rebase
          echo "âœ… Latest changes pulled"

      - name: ðŸ” Resume from Last State
        id: resume
        run: |
          if [ "${{ inputs.force_new }}" == "true" ]; then
            echo "ðŸ†• Starting fresh session"
            echo "resume=false" >> $GITHUB_OUTPUT
          elif [ -f "state/current-session.json" ]; then
            echo "ðŸ“‚ Resuming from previous session"
            echo "resume=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ†• No previous state found"
            echo "resume=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŽ¯ Run Autonomous Orchestrator (LangGraph + Failover)
        env:
          GITHUB_TOKEN: ${{ secrets.GHTOKEN}}
          MODEL: ${{ vars.MODEL || 'opencode/gpt-5-nano' }}  # OpenCode models via OpenClaw
          OPENCODE_MODEL: ${{ vars.OPENCODE_MODEL || 'opencode/gpt-5-nano' }}  # Fallback
          IDEA_ID: ${{ steps.create_idea.outputs.idea_id || inputs.idea_id }}
          RESUME: ${{ steps.resume.outputs.resume }}
          TIMEOUT_MINUTES: 23  # Leave 2min buffer for cleanup
        run: node scripts/orchestrator-with-failover.js

      - name: ðŸ’¾ Commit Progress
        if: always()
        run: |
          git config --local user.email "satishkumar.dhule@gmail.com"
          git config --local user.name "satishkumar-dhule"

          # Stage all changes
          git add -A

          # Check if there are changes
          if ! git diff --staged --quiet; then
            # Get milestone from state (with fallback if file doesn't exist)
            if [ -f "state/current-session.json" ]; then
              MILESTONE=$(node -e "const s=require('./state/current-session.json');console.log(s.milestone||'Progress update')")
            else
              MILESTONE="Progress update"
            fi

            git commit -m "ðŸ¤– Auto: $MILESTONE [skip ci]"
            git push origin dev
            echo "âœ… Committed and pushed to dev"
          else
            echo "â­ï¸ No changes to commit"
          fi

      - name: ðŸ“Š Update GitHub Issues
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GHTOKEN}}
        run: node scripts/utils/issue-tracker.js sync

      - name: ðŸ“ˆ Generate Summary
        if: always()
        run: |
          echo "## ðŸ¤– Autonomous Dev Session Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ env.OPENCODE_WEB_URL }}" ]; then
            echo "ðŸŒ **OpenCode Web**: [${{ env.OPENCODE_WEB_URL }}](${{ env.OPENCODE_WEB_URL }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "state/current-session.json" ]; then
            node -e "
              const s = require('./state/current-session.json');
              console.log(\`**Idea:** \${s.idea_id || 'N/A'}\`);
              console.log(\`**Status:** \${s.status || 'unknown'}\`);
              console.log(\`**Progress:** \${s.progress || 0}%\`);
              console.log(\`**Milestone:** \${s.milestone || 'N/A'}\`);
              console.log(\`**Next Step:** \${s.next_step || 'TBD'}\`);
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "No session state found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ›‘ Stop OpenCode Web & Cloudflared
        if: always()
        run: |
          # Stop cloudflared tunnel
          if [ -f /tmp/cloudflared.pid ]; then
            kill $(cat /tmp/cloudflared.pid) 2>/dev/null || true
            echo "âœ… Cloudflared tunnel stopped"
          fi

          # Stop opencode web server
          if [ -f /tmp/opencode-web.pid ]; then
            kill $(cat /tmp/opencode-web.pid) 2>/dev/null || true
            echo "âœ… OpenCode web server stopped"
          fi

  cleanup:
    name: ðŸ§¹ Cleanup
    needs: [autonomous_work]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Runner Status
        run: |
          echo "Session completed with status: ${{ needs.autonomous_work.result }}"
