name: ðŸ¤– Autonomous Development

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:
    inputs:
      idea_id:
        description: 'Specific idea ID to work on'
        required: false
      vibe:
        description: 'Quick idea description (creates new idea automatically)'
        required: false
      force_new:
        description: 'Start fresh (ignore resume state)'
        type: boolean
        default: false

jobs:
  autonomous_work:
    name: ðŸš€ Autonomous Dev Session
    runs-on: ubuntu-latest
    timeout-minutes: 50  # 50-minute timeout (includes 20-min web wait)
    permissions:
      contents: write
      issues: write
      pull-requests: write
    env:
      OPEN_CODE_MODELS_DIR: ${{ github.workspace }}/opencode-models
      OPEN_CODE_MODELS_URLS: ${{ secrets.OPEN_CODE_MODELS_URLS }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev  # Always work on dev branch

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache OpenCode Models\n        uses: actions/cache@v4\n        with:\n          path: ${{ env.OPEN_CODE_MODELS_DIR }}\n          key: opencode-models-${{ runner.os }}-${{ github.sha }}\n          restore-keys: opencode-models-${{ runner.os }}-\n\n      - name: ðŸ—‚ Setup OpenCode Models\n        run: bash scripts/setup-opencode-models.sh
        env:
          OPEN_CODE_MODELS_DIR: ${{ env.OPEN_CODE_MODELS_DIR }}
          OPEN_CODE_MODELS_URLS: ${{ env.OPEN_CODE_MODELS_URLS }}

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ¤– Install OpenCode AI CLI
        run: |
          # Install the real opencode-ai package
          npm install -g opencode-ai

          # Verify installation
          opencode --version

          # Create openclaw alias pointing to opencode for backward compatibility
          echo '#!/bin/bash' | sudo tee /usr/local/bin/openclaw > /dev/null
          echo 'exec opencode "$@"' | sudo tee -a /dev/null 2>/dev/null || true
          sudo chmod +x /usr/local/bin/openclaw

          echo "âœ… OpenCode AI installed successfully"

      - name: ðŸŒ Start OpenCode Web Server
        run: |
          # Start opencode web in background
          nohup opencode web --port 3000 > /tmp/opencode-web.log 2>&1 &
          WEB_PID=$!
          echo $WEB_PID > /tmp/opencode-web.pid
          echo "ðŸš€ OpenCode web server started (PID: $WEB_PID)"

      - name: ðŸ” Select Idea to Work On
        id: select_idea
        run: |
          if [ -n "${{ inputs.vibe }}" ]; then
            echo "ðŸŽ¨ Creating idea from vibe: ${{ inputs.vibe }}"
            OUTPUT_JSON=true node scripts/create-idea.js "${{ inputs.vibe }}" > /tmp/idea-output.txt
            IDEA_JSON=$(tail -n 1 /tmp/idea-output.txt)
            IDEA_ID=$(echo $IDEA_JSON | jq -r '.ideaId')
            echo "âœ… Created new idea: $IDEA_ID"
          elif [ -n "${{ inputs.idea_id }}" ]; then
            IDEA_ID="${{ inputs.idea_id }}"
            echo "âœ… Using specified idea: $IDEA_ID"
          else
            IDEA_FILE=$(ls ideas/backlog/*.md | grep -E '^ideas/backlog/[0-9]{3}-' | head -1)
            if [ -n "$IDEA_FILE" ]; then
              IDEA_ID=$(basename "$IDEA_FILE" | sed 's/-.*$//')
              echo "âœ… Selected existing idea: $IDEA_ID"
            else
              echo "âŒ No ideas found in backlog"
              exit 1
            fi
          fi

          echo "idea_id=$IDEA_ID" >> $GITHUB_OUTPUT

      - name: ðŸŽ¯ Run Autonomous Orchestrator (Pure OpenCode AI)
        env:
          GITHUB_TOKEN: ${{ secrets.GHTOKEN }}
          MODEL: ${{ vars.MODEL || 'opencode/gpt-5-nano' }}  # OpenCode models (no LangGraph)
          OPENCODE_MODEL: ${{ vars.OPENCODE_MODEL || 'opencode/gpt-5-nano' }}  # Fallback
          IDEA_ID: ${{ steps.select_idea.outputs.idea_id }}
          TIMEOUT_MINUTES: 25  # Allow more time for all milestones
          OPEN_CODE_MODELS_DIR: ${{ env.OPEN_CODE_MODELS_DIR }}
        run: node scripts/orchestrator-opencode.js

      - name: ðŸ’¾ Commit Progress
        if: always()
        run: |
          git config --local user.email "ci@example.com"
          git config --local user.name "CI Bot"

          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– Auto: CI progress update [skip ci]"
            git pull --rebase origin dev || true
            git push origin dev
          else
            echo "â­ï¸ No changes to commit"
          fi

      - name: ðŸ“Š Update GitHub Issues
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GHTOKEN}}
        run: node scripts/utils/issue-tracker.js sync

      - name: ðŸ“ˆ Generate Summary
        if: always()
        run: |
          echo "## ðŸ¤– Autonomous Dev Session Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ env.OPENCODE_WEB_URL }}" ]; then
            echo "ðŸŒ OpenCode Web: [${{ env.OPENCODE_WEB_URL }}](${{ env.OPENCODE_WEB_URL }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: â° Keep OpenCode Web Accessible
        if: always()
        run: |
          echo "ðŸŒ OpenCode Web URL: ${{ env.OPENCODE_WEB_URL }}"
          echo "â° Keeping web interface alive for 20 minutes..."
          for i in {1..20}; do echo "â³ $i"; sleep 60; done

      - name: ðŸ›‘ Stop OpenCode Web & Cloudflare
        if: always()
        run: |
          if [ -f /tmp/cloudflared.pid ]; then kill $(cat /tmp/cloudflared.pid) 2>/dev/null || true; fi
          if [ -f /tmp/opencode-web.pid ]; then kill $(cat /tmp/opencode-web.pid) 2>/dev/null || true; fi
